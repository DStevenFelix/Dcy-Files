# 嵌入式系统原理

###  第一章 绪论部分

#### 1.1 嵌入式系统定义:

嵌入式系统是"控制、监视或者辅助设备、机器和车间运行的装置"。——IEEEE的定义

**嵌入式系统**是嵌入到计算机体系中的、用于执行独立功能的**专用计算机系统**

以**应用**为中心，以**计算机、通信、控制**等技术为基础，采用可剪裁软硬件，适用于对功能、可靠性、成本、体积、功耗等有严格要求的**专用计算机系统**

![image-20240620095155633](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620095155633.png)

**所有的控制系统都是一个完整的嵌入系统**

---

**嵌入式系统三要素: **

**1、嵌入性 ：满足环境要求**

**2、专用性 ： 满足配置要求**

**3、计算机系统： 满足控制要求**

---

嵌入式系统与桌面通用系统的区别:

1、嵌入式系统中运行的任务是专用而确定的，桌面通用系统需要支持**大量的、需求多样**的应用程序

2、嵌入式系统往往对**实时性**提出较高要求

3、嵌入式系统对**可靠性**要求高

4、嵌入式系统有功耗约束

5、嵌入式系统内核小，可用资源少

6、嵌入式系统开发需要**专用工具**和**特殊方法** 

**单片机开创了嵌入式系统独立发展之路**

嵌入式中核心技术:3C(通信【Communication】计算机【Computer】消费电子【Consume Electronic】)

---

#### 1.2嵌入式系统的结构

**嵌入式系统**一般由**嵌入式处理器**、**外围硬件设备**、**嵌入式操作系统**（可选），以及**用户的应用软件系统**组成

#### 1.3嵌入式系统的分类

1、按嵌入式微处理器的字长分类（4位，8位，16位，32位，64位）

2、按软件实时性需求分类(【非实时，软实时（偶然错过时间不会导致灾难性后果），硬实时（严格实时，超出时间导致灾难性后果）】)

3、按系统复杂程度分类(小型系统，中型系统，复杂系统)

4、按系统形态分类(芯片级、板级、设备级)

![image-20240620103705086](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620103705086.png)

---

### 第二章 ARM微处理器与编程模式

#### 2.1 ARM相关概念

**冯诺依曼结构**:将程序和数据存放在同一存储器的不同地址，**顺序**执行指令。【单条总线】

![image-20240620105703145](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620105703145.png)

---

**哈佛结构**:将程序和数据存放在不同的存储器中，**并行**执行指令。【分离总线】

![image-20240620105821594](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620105821594.png)

---

**ARM微处理器中使用RISC**

**RISC【精简指令集计算机】**:借助一些可以在单个CPU周期完成的指令以降低CPU的复杂度，将**程序复杂性交给编译器**

1、只包含最有用的指令，只提供简单的操作

2、确保数据通道快速执行每一条指令

3、**Load-Store结构**:CPU**只**处理寄存器中的数据，使用Load/Store指令来完成数据在**寄存器和外部存储器**之间的传送。【用于寻址】

**CISC【复杂指令集计算机】**:用**最少的机器语言指令**来完成所需的计算任务

1、包括大量具有复杂功能的指令和**丰富的寻址方式**

2、**8/2**原则：常用指令仅占指令总数的20%，但在程序中出现的频率却占80%

3、大多数程序只使用少量的指令就可以运行

4、**与嵌入式系统的要求相悖**

![image-20240620111353211](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620111353211.png)

**哈弗结构**与**冯诺依曼结构**主要是计算机的存储器结构，与指令系统没有严格的对应关系

---

#### 2.2 ARM微处理器

**ARM体系结构版本的命名规则**：

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620112441874.png" alt="image-20240620112441874" style="zoom: 50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620114230853.png" alt="image-20240620114230853" style="zoom: 80%;" />

**变种类型**:【F表示{F} 指的是 **FPU（Floating Point Unit）**，即浮点运算单元，是否支持硬件浮点运算】

![image-20240620114316764](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620114316764.png)

![image-20240620120733265](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620120733265.png)

#### 2.3 ARM结构

**外部设备与外围设备区别:**

- 外部设备【通常所理解的外设输入输出设备，存储和网络设备等】：
  - 外部设备通常指的是与 **ARM处理器通过总线**（如数据总线、地址总线、控制总线）相连的设备。
  - 外部设备可以是 **存储器芯片**（如闪存、RAM），**外部接口**（如UART、SPI、I2C）、**传感器**、**显示器**等。
  - 它们是通过总线进行数据传输和控制信号的交互，是指与CPU相连的外部存储器，如RAM、ROM、Flash等。

+ 外围设备【嵌入在微控制器或系统级芯片内部或直接连接到微控制器的设备，**CPU外部的设备**】:
  + 外围设备是指与**ARM处理器相连的外部硬件模块或接口，用于拓展ARM处理器的功能和连接外部设备**
  + 外围设备包括各种控制器和接口，如**DMA处理器、定时器、GPIO接口、以太网控制器、USB控制器等。**
  + 其与ARM处理器通过总线或专用接口相连，用于处理特定的输入输出任务

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620122921000.png" alt="image-20240620122921000" style="zoom: 80%;" />

**不可以说外围设备是外部设备，二者没有包含关系**

![image-20240629141020457](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240629141020457.png)

---

#### 2.4 ARM运行模式

1、**用户模式【USR】**:ARM处理器正常程序执行状态

2、**快速中断模式【FIQ】**:用于高速数据传输或通道处理

3、**外部中断模式【IRQ】**:用户通用的中断处理

4、**管理模式【SVC】**:操作系统使用的保护模式，处理软件中断

5、**数据访问中止模式【ABT】**:当数据或指令预取中止时进入该模式，可以用于虚拟存储器和存储器保护

6、**未定义指令模式【UND】**:当未定义的指令执行时进入该模式，可用于支持硬件协处理器的软件仿真

7、**系统模式【SYS】**:运行具有特权的操作系统任务

+ **除了用户模式【USR】外，其余6种模式称为特权模式**

---

**特权模式与用户模式的比较**

+ 在**特权模式**下，程序可以访问所有的系统资源(内部寄存器与片内外设)，也可以**任意地进行处理器模式地切换**
+ 但是大多数应用程序运行在**用户模式**下,此时，**某些被保护的系统资源无法被访问，应用程序也不能直接进行处理器模式的切换**
+ **用户模式下**，当需要进行处理器模式切换时，应用程序可以产生异常处理，在异常处理中进行处理器模式的切换
+ **系统模式**不可由异常进入，而且系统模式中使用完全相同的寄存器组；**系统模式**是特权模式，不受用户模式的限制，操作系统在该模式下可以访问用户模式的寄存器，而且一些特权任务还可以使用这个模式访问一些受控的资源。

**异常模式**

除**用户**和**系统程序**外，其余5种模式称为**异常模式**。

+ 异常模式常用于**处理中断**或**异常**以及**访问受保护的系统资源**等情况。

异常模式包括(**快速中断模式【FIQ】,外部中断模式【IRQ】,管理模式【SVC】,数据访问中止模式【ABT】,未定义指令模式【UND】**)

---

**模式转换的方法**:

+ ARM处理器的运行模式可以通过程序切换进入，当特定的异常出现时处理器进入相应的模式

![image-20240620205035690](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620205035690.png)

**启动时的模式转换方式**:

![image-20240620205149312](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620205149312.png)

#### 2.5 ARM微处理器的工作状态

![image-20240620205505925](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620205505925.png)

两种不同状态之间进行转换时，**不影响处理器的模式与寄存器的内容**

**ARM指令集与Thumb指令集**

+ ARM指令集
  + 具有固定宽度的32位指令，需要4字节进行对齐操作
  + 在有限的存储空间中，存放的指令少，代码密度【单位存储空间中包含的指令条数】比较低

+ Thumb指令集
  + 自ARMv4T板架构【ARM7TDMI】开始,为了减少代码量而提出
  + 只支持一些通用功能，不是一套完整的指令体系，可以看做是ARM指令压缩形式的子集
  + 必要时仍需要ARM指令集支持

**ARM与Thumb指令集的区别**

![image-20240620210950562](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620210950562.png)

---

**切换到Thumb状态方式**

+ 当**操作数寄存器Rm**的状态位**bit[0]=1**时，可以通过执行**BX Rm指令**，使微处理器从ARM状态切换到Thumb状态。

+ 当处理器处于**Thumb**状态时，若发生异常处理(IRQ、FIQ、Undef、Abort、SWI等)，则异常处理返回时，自动切换至Thumb状态

![image-20240620211727036](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620211727036.png)

**切换到ARM状态方式**

+ 当**操作数寄存器Rm**的状态位**bit[0]=0**时，可以通过执行**BX Rm指令**，使微处理器从Thumb状态切换至ARM状态
+ 在处理器进行**异常处理**时,若把**PC**指针放入异常模式的**链接寄存器LR**中，并从异常向量地址开始执行程序，则同样可以使处理器切换到ARM状态

![image-20240620212911148](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620212911148.png)

#### 2.6 ARM寄存器相关

##### ARM微处理器寄存器

ARM状态下【37】种  **均为32位寄存器**

1、**通用寄存器【31】**

+ 未分组寄存器【R0 - R7】（8个）

  + 在所有7种运行模式下，均指向相同的物理寄存器

  + 用于**保存数据或地址，未被用作特殊用途**(完全称之为--通用寄存器)

  + **注意:**工作模式转换时，可能造成寄存器中数据的损坏

    ![image-20240620214226214](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620214226214.png)

+ 分组寄存器【R8 - R14】
  + 分组寄存器【R8 - R12】（5个）
    + 每次访问的**物理寄存器**与**当前的运行模式相关**
    + 每个寄存器对应**两个**不同的物理寄存器
      + 当使用**快速中断模式**时，对应R8_fiq —>R12_fiq
      + 当使用其它模式时，对应R8_usr —>R12_usr

![image-20240620214858777](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240620214858777.png)

+ + 分组寄存器【R13、R14】(2个)

    + 每个寄存器对应**6**个不同的物理寄存器 

      + 其中一个物理寄存器时**用户模式与系统模式**共用，另外5个对应其它五种运行模式

      + 采用R13_<mode>,R14_<mode> 来区分不同的物理寄存器

        

![image-20240621075211884](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621075211884.png)

+ + + **R13寄存器** - 堆栈指针
      + 在ARM指令集中通常用作堆栈指针
      + 在Thumb指令集中，某些指令强制性要求使用R13作为堆栈指针
      + 每种运行模式含有自己独立的物理寄存器R13，**在初始化时，需要初始化每种模式对应的R13**
      + **使用方式:**

![image-20240621103342603](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621103342603.png)

+ + + **R14寄存器** - 子程序链接寄存器 **【链接寄存器LR】**

      + 当执行**子程序调用指令BL时**，可以用于得到**程序计数器PC【R15】**的备份
      + **两种特殊功能**
        + 在每种情况下均可以用于**保护子程序的返回地址**
        + 发生异常时，用于保存**异常处理后的返回地址**，如中断

      + 正常情况下，用作**通用寄存器**
      + R14中存放子程序跳转前下一条指令的地址

      ![image-20240621105147170](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621105147170.png)

+ + + + **注意**:当发生异常嵌套时，这些异常之间可能发生冲突
        + 1、如果在用户模式下执行程序时发生了IRQ中断，硬件将用户模式下下一条指令的地址存放在IRQ模式下的R14_irq寄存器，用户模式下的R14未被破坏
        + 2、当IRQ服务程序执行完毕后，通过将R14的内容存入PC返回被中断的程序
        + 3、但若在IRQ处理过程中打开了IRQ中断，并且再次发生了IRQ中断或调用子程序，硬件会将对应返回的地址存入R14_irq寄存器中，**原来保存的地址将被覆盖**，造成错误
        + 4、此时在执行完IRQ模式下的程序后，只能返回IRQ模式下下一条指令处，无法返回用户模式

      + **解决方式**:发生中断嵌套时，使用**堆栈**保存R14的值，或者切换至其余寄存器模式下

+ + **程序计数器PC【R15】**
    + 在所有运行模式下【7种】 ，均指向**同一个物理寄存器**
    + ARM 【32位】状态下，地址是**4字节**对齐的，在此种状态下，bit[31:2]用于存放指令地址
    + Thumb【16位】状态下，地址是**2字节**对齐的，在此种状态下，bit[31:1]用于存放指令地址
    + + **注意**:由于ARM体系采用多流水线结构，因此对于ARM，PC总是指向当前指令的下两条指令，即PC的值为当前指令的地址 +8 

![image-20240621114319422](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621114319422.png)

**31个通用寄存器包含:**

+ **R0-R7 (8个)  R8-R12(5个) R8_fiq - R12_fiq(5个)**
+ **R13(6个【对应于5种特权模式 以及一种正常模式(USR与SYS)】)**
+ **R14(6个【对应于5种特权模式 以及一种正常模式(USR与SYS)】)**
+ **R15(1个)**

****

2、**状态寄存器【6】**

+ **CPSR(1个)【当前程序状态寄存器】**:
  + **所有运行模式下**，均指向相同的物理寄存器，可在任何运行模式下被访问
+ **SPSR(5个)【备份程序状态寄存器】:**
  + 每种**异常模式**都有自己专用的寄存器
  + 异常发生时，保存**CPSR**;异常退出时用于恢复CPSR
  + **用户模式与系统模式下无效**【没有相应的寄存器与之对应】

寄存器控制格式:

![image-20240621120610740](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621120610740.png)

+ + 条件码标志位【N、Z、C、V】:
    + 条件码标志位可被算术或逻辑运算的结果改变，并且可以决定某条指令是否被执行
      + ARM状态下，绝大多数指令都是有条件执行的
      + THumb状态下，仅有分支指令是有条件执行的
    + ![image-20240621121305515](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621121305515.png)

+ + 保留位:为了提高程序的可移植性以及保证程序后续的兼容性

+ + 控制位【I、F、T及M[4:0]】：**处理器处于特权模式时才可被修改**

+ + + ![image-20240621121924171](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621121924171.png)

+ + + **若使用了错误的设置将会引起无法恢复的错误**
    + ![image-20240621121955309](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621121955309.png)

+ + + **该状态位由外部引脚TBIT决定，在程序中不能进行修改，否则处理器工作状态无法确定**
    + ![image-20240621122143965](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621122143965.png)

Thumb状态下【27】种  **均为32位寄存器**

+ 通用寄存器【21】
+ + 程序可直接访问的8个通用寄存器(R0 - R7)【8个】
  + 堆栈指针SP【6个】
  + 链接寄存器LR【6个】
  + 程序计数器PC【1个】

+ 状态寄存器
+ + 当前状态寄存器【CPSR，1个】
  + 备份程序计数器【SPSR，5个】

![image-20240621123249585](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621123249585.png)

**两种状态下寄存器组的关系**

+ 8个通用寄存器【R0 - R7完全相同】

  + 用于保存数据或地址
  + 对于任何运行模式，每一个都对应相同的32位物理寄存器
  + 完全通用的寄存器，不会用作特殊功能，可用于任何使用的通用寄存器

+ CPSR与SPSR完全相同

+ 3种特殊寄存器:

  ![image-20240621123647482](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621123647482.png)

![image-20240621123804778](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621123804778.png)

#### 2.7 ARM微处理器存储器格式

ARM体系结构中存储器格式

![image-20240621222327812](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621222327812.png)

**大端格式**:

+ 字数据的**高字节**存储在**低地址**中而字数据的**低字节**存放在**高地址**中

**小端格式**:

+ 字数据的**高字节**存储在**高地址**中，而字数据的**低字节**存放在**低地址**中

**内存管理**(**\***)

![image-20240621223224213](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621223224213.png)

**存储器管理单元MMU**:

+ 将虚拟地址转换成物理地址 - 将主存地址从虚拟存储空间映射到物理存储空间
+ 存储器访问权限控制
+ 设置虚拟存储空间的缓冲特性等
+ **注意**:MMU无效时，虚拟地址将直接输出到物理地址总线

![image-20240621223941962](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621223941962.png)

**虚拟存储管理**

+ 分段式存储管理
+ 分页式存储管理
+ 段页式存储管理

**分页式存储管理**:

+ 把虚拟存储空间分成一个个**固定**大小的**页**，把物理主存的空间也分成同样大小的页
+ 通过查询存放在主存中的**页表**，实现虚拟地址到物理地址的转换 --【对照表】
+ 由于查询页表的代价很大，采用快表技术**TLB**提高地址转换速率

![image-20240621225149134](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621225149134.png)

**基于TLB的地址转换过程**:

+ 微处理器访问主存时，首先根据主存虚拟地址在TLB中查找对应的转换条目。若存在(Hit命中)，直接转换
+ 若不存在，则继续在位于**主存**的页表中进行查找，并将查找到的结果(**地址转换条目**)添加到TLB中 --对TLB更新
+ 在添加时，若TLB已满，根据一定淘汰算法进行替换

**两种存储空间的映射单位**:

+ 虚拟存储空间到物理存储空间的映射是以**存储块**为单位进行的
+ 在页表/TLB中，每个Entry记录了一个虚拟存储空间的**存储块**的**基地址**与物理存储空间的一个**存储块**的**基地址**的对应关系

![image-20240622101532211](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622101532211.png)

**ARM920T支持的存储块**类型：

+ 段描述符 
  + 对应段 ，大小为【1MB存储块】
+ 大页描述符
  + 对应大页 ，大小为【64KB存储块】
+ 小页描述符
  + 对应小页 ， 大小为【4KB存储块】
+ 极小页描述符
  + 对应极小页 ， 大小为【1KB存储块】

---

**一级页表结构**:【每项**1MB**,共占用主存的存储空间**16KB**存储空间，共**4096**项

**二级页表结构**:【分为二级粗页表与二级细页表】

+ 二级粗页表:【每项**4KB**,共占用主存的存储空间为**1KB**,**共256项**】

+ 二级细页表:【每项**1KB**,共占用住处的存储空间为**4KB**,**共1024项**】

**重点:**

![image-20240622111359635](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622111359635.png)

![image-20240622113735180](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622113735180.png)

+ 1、根据给定的虚拟地址查找一级页表获得一个条目Entry
+ 2、若该条目为**段描述符**【**1MB**(每项的大小)】，则返回物理地址，转换结束【**单步搜索**】
+ 3、若该条目为**粗页表目录项**，则继续利用虚拟地址查找二级粗页表，获得大页【**64K**】或小页【**4K**】描述符，返回物理地址，转换结束【**两步搜索**】
+ 4、若该条目是**细页表目录项**，则继续利用虚拟地址查找二级细页表，获得极小页【**1KB**】描述符，返回物理地址，转换结束【**两步搜索**】
+ 5、剩余情况出错

---

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622125732516.png" alt="image-20240622125732516" style="zoom:150%;" />

**上图指出了查询页表的过程以及对应的查找范围和方式**

**CP15**【系统控制协处理器】

+ 包含16个32位寄存器【0-15】
+ 对MMU进行配置，完成存储器系统管理操作
  + 页表与TLB
  + 域和访问权限
  + Cache和写缓冲器
  + 快速上下文切换

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622130054504.png" alt="image-20240622130054504" style="zoom:50%;" />

C1用于禁止或使能MMU

+ C1的位[0]用于禁止/使能MMU
  + C1 [0] = 0 表示禁止MMU
  + C1 [0] = 1 表示使能MMU

禁止MMU后，**虚拟地址 = 物理地址**，无访问限制，MMU不产生异常信号

**禁止/使能MMU**：![image-20240622130427022](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622130427022.png)

![image-20240622130643313](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622130643313.png)

**MMU对应4种存储访问失效**:

+ 1、地址对齐失效
+ 2、地址变换失效
+ 3、域控制失效
+ 4、访问权限控制失效
+ **发生存储访问失效时，存储系统可以中止3种存储访问**:
  + Cache内容预取
  + 非缓冲的存储器访问
  + 页表访问

存储访问失效的**检测机制**:

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622131111769.png" alt="image-20240622131111769" style="zoom:33%;" />

存储访问失效的**存储访问中止异常**:

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622131149500.png" alt="image-20240622131149500" style="zoom:33%;" />



#### 2.8 ARM微处理器异常处理

**正常执行:**每执行一条ARM指令，程序计数寄存器(PC)+ 4字节 ；每执行一条Thumb指令，程序计数寄存器(PC)+2字节；整个过程按顺序进行

+ 通过跳转指令(B,BL,BLX,BX)，程序可以跳转至特定位置处进行执行

+ 当正常的程序执行流程发生暂时的停止时，称为**异常**

**异常处理**:

+ 1、当异常发生时，系统执行完当前指令后，保存处理器当前状态(执行现场)，然后跳转至相应的异常处理程序处执行
+ 2、当异常处理程序执行完毕后，程序应恢复所保存的执行现场，从而返回到发生异常时的下一条指令继续执行。
  + 处理器允许多个异常同时发生，它们会按固定的优先级顺序进行处理操作

**优先级**:

![image-20240621144634421](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621144634421.png)

**异常处理以及对应的异常向量地址**

![image-20240621145911408](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240621145911408.png)

**异常处理步骤**:

+ 1、将下一条指令的地址存入相应的链接寄存器**LR**中，以便程序在处理异常返回时可以从正确的位置重新开始执行
+ 2、将CPSR复制到相应的SPSR中
+ 3、根据异常的类型，强制设置CPSR的运行模式位置【不同的异常类型需要转换至不同的**异常**模式】
+ 4、强制PC从相关异常向量地址取下一条指令执行，从而跳转到相应的异常处理程序处，同时设置中断禁止位
+ **注意:若当前处理器处于Thumb状态，当异常向量地址加载进入PC时，处理器会自动切换至ARM状态**
  + 由于异常处理程序通常时由ARM指令集编写的

**异常返回步骤**:

+ 1、将链接寄存器**LR**的值减去相应的偏移量送至PC中【由于异常发生时处理器会将当前PC的值保存LR中，但此时PC中存放的值已经不是当前指令的地址而是即将执行的地址，因此需要先减去偏移量即**使得处理器正确返回至异常处理前的状态，使得PC正确指向PC发生异常时的指令地址**】

+ 2、将SPSR复制回CPSR中【**恢复CPSR的动作会将”T“,"F"以及"I"位自动恢复至异常前的值**】

+ 3、若在进入异常处理时设置了中断禁止位，要在此进行清除

+ 若为复位异常，复位异常处理程序的执行**不需要返回到原来的执行点**，因为它的目的是重新初始化系统，并从应用程序的起始点重新开始执行。这个设计确保系统在复位后能够可靠地启动和运行，而不受复位前系统状态的影响。

![image-20240626163118784](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240626163118784.png)

**进入IRQ模式后设置I位置为1禁止IRQ中断 防止在中断中又产生中断**同时需要清零T位进入ARM状态

### 第三章 ARM指令集与汇编设计

#### 3.1 寻址方式

+ 指令：计算机控制各功能部件协调动作的命令
+ 指令系统:微处理器所能执行的全部指令的集合
  + **不同微处理器拥有不同的指令系统**
  + 指令由硬件直接识别并执行，指令系统中指令数量愈多，硬件结构也就越复杂
+ 机器语言指令(机器码):能被微处理器**直接识别和执行的二进制编码**，是指令在计算机内部的表示形式
+ 汇编语言指令:机器指令的符号化表示形式 

**寻址方式:**【微处理器根据指令中由操作数给出的地址信息来**寻找真实的物理地址**】

+ 1、寄存器寻址:
  + 指令中操作数指出的是寄存器编号，指令执行时**直接**取出寄存器的数值进行操作
  + <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622165443389.png" alt="image-20240622165443389" style="zoom:50%;" />
+ 2、立即寻址:
  + 指令中的操作数就是数据本身，数据包含在指令中，取出指令也就取出了可以立即使用的数
  + <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622165452624.png" alt="image-20240622165452624" style="zoom:50%;" />
+ 3、寄存器偏移寻址:
  + **ARM指令集特有的寻址方式，当指令中某个操作数是该寻址方式时，对其操作前，首先进行移位操作**
  + <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622165505698.png" alt="image-20240622165505698" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622153502255.png" alt="image-20240622153502255" style="zoom:50%;" />

+ 4、寄存器间接寻址:
  + 指令中的操作数给出的是一个通用寄存器的编号，所需要的操作数保存在寄存器指定地址的存储单元中，即寄存器为操作数的地址指针
  + <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622165532487.png" alt="image-20240622165532487" style="zoom:50%;" />

+ 5、基址寻址:
  + 将基址寄存器的内容与指令中给出的偏移量相加，形成操作数的有效地址
  + <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622165551674.png" alt="image-20240622165551674" style="zoom:50%;" />

+ 6、多寄存器寻址:
  + 一次可以传送几个寄存器值，允许一条指令传送**16**个寄存器的任何子集或所有寄存器
  + 使用多寄存器寻址指令时候，寄存器子集的顺序是按照**从小到大**的顺序排列，连续寄存器可用"—"连接
  + 

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622160052638.png" alt="image-20240622160052638" style="zoom:50%;" />

上图表示将R1指向的顺序存储单元中的数据读出到R2---R4与R6中(R1自动加4)

+ 7、堆栈寻址【上方为大地址存储单元】

  + 堆栈是存储器中一个按特定顺序进行存取的区域
  + 堆栈寻址是隐含的，它使用一个专门的寄存器(堆栈指针)指向一块存储区域，指针所指向的存储单元称为堆栈的栈顶
  + 四种类型堆栈:
    + 1、满递增:堆栈向上增长，堆栈指针指向内含有有效数据的最高地址。指令:LDMFA、STMFA
    + 2、空递增:堆栈向上增长，堆栈指针指向堆栈上的第一个空位置。指令:LDMEA、STMEA
    + 3、满递减:堆栈向下增长，堆栈指针指向内含有有效数据的最低地址。指令:LDMFD、STMFD
    + 4、空递减:堆栈向下增长，堆栈指针向堆栈下的第一个空位置。指令:LDMED、STMED

  **注意入栈和出栈的顺序:**

  ![image-20240625143409388](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625143409388.png)

  ```assembly
  STMFD R0!,{r4-r7,lr}
  ```

  这是一条满递减指令，由高到低依次将内容放入R0指向的位置 即由高到低内容分别为:lr r7 r6 r5 r4

  ```assembly
  LDMFD R0!,{r4-r7,lr}
  ```

  这是一条满递减指令【但实际上是对应着STM的出栈操作】，由低向高依次将R 0中的内容取出，放入r4 r5 r6 r7 lr中

+ 8、相对寻址

  + 基址变址的一种。由程序计数器PC提供基准地址，指令中的操作数作为偏移量，两者相加之后得到的地址即为操作数的有效地址

---

#### 3.2 ARM指令集

+ RISC 【加载/存储型】
  + 指令集仅能处理寄存器中的数据，而且处理结果都要放回寄存器中
  + 对存储器的访问需要通过专门的加载/存储指令来完成

ARM与Thumb指令集的关系:

+ ARM指令集支持ARM核所有特性，具有高效，快速的特点

+ Thumb指令集具有灵活，小巧的特点

**ARM指令的基本格式**

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622171331226.png" alt="image-20240622171331226" style="zoom:50%;" />

+ 条件码cond
  + 可以实现高效的逻辑操作
  + 所有**ARM指令都可以条件执行**；而**Thumb指令只有B(跳转）指令具有条件执行功能**
  + 若指令不标明条件码，则默认为无条件**(AL)**执行

+ 标志影响位S
  + 默认情况下，数据处理指令不影响CPSR的条件码标志位，但通过添加S可以影响
  + **特殊**:cmp指令【比较指令】无需添加‘’S‘’就可以改变相应标志位
+ 分支指令:

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622173340269.png" alt="image-20240622173340269" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622173805676.png" alt="image-20240622173805676" style="zoom:67%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622174929732.png" alt="image-20240622174929732" style="zoom:50%;" />

+ 数据处理指令:
  + 数据传送指令
  + 算术/逻辑运算指令
  + 比较指令

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622175130588.png" alt="image-20240622175130588" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622175146704.png" alt="image-20240622175146704" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622175912425.png" alt="image-20240622175912425" style="zoom:50%;" />

**对比：加法与减法不同，若加法中之前操作存在有进位，则进位标志为1 反之为0；但若为减法，则若之前减法操作中存有借位，则进位标志位0 不存在借位时，进位标志为1**

![image-20240622181215232](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622181215232.png)

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622181435373.png" alt="image-20240622181435373" style="zoom:50%;" />

**存储器访问指令** 多寄存器加载/存储指令

+ LDM和STM指令可以实现在一组寄存器和一块连续的内存单元之间传输数据。LDM为加载多个寄存器，STM为存储多个寄存器
+ 允许一条指令传送16个寄存器的任何子集或所有寄存器
+ ![image-20240622183034866](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622183034866.png)

LDM,STM的**主要用途**是保护现场，数据复制，参数传递

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622195905816.png" alt="image-20240622195905816" style="zoom:50%;" />

---

**关于加载/存储指令**

+ 指令格式中，Rn为基址寄存器，装有传送数据的初始地址，因此Rn不允许为R15,也就是基址寻址，寄存器间接寻址等不允许使用R15
+ ''**!**''表示最后的地址写回至Rn中 --立即更新Rn后再进行操作
+ ''**^**''用于在指令执行结束后更新CPSR或保存和恢复寄存器状态
  + **不允许在用户模式和系统模式下使用**
  + 在LDM指令同时寄存器列表中包含PC时，除了正常的多寄存器传送外。还会将**SPSR**拷贝到CPSR中用于异常处理返回
  + 若寄存器列表不包含PC，则加载/存储的是用户模式的寄存器，而非当前(异常)模式下的寄存器

**存储访问指令** 寄存器与存储器交换指令

+ SWP

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622214310304.png" alt="image-20240622214310304" style="zoom:50%;" />

**若 Rm与Rd相同时 此时将Rd中的内容和R0存储的内容进行交换(R0地址)**

杂项指令:

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622220328694.png" alt="image-20240622220328694" style="zoom:50%;" />

+ 读状态指令:
  + <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622220720963.png" alt="image-20240622220720963" style="zoom:50%;" />
  + **注意**:在ARM处理器中，只有MRS指令可以将状态寄存器CPSR或SPSR读出到通用寄存器中

+ 写状态指令:

  + <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622220926827.png" alt="image-20240622220926827" style="zoom:50%;" />
  + **注意**:在ARM处理器中，只有MSR指令可以对状态寄存器CPSR或SPSR进行写操作
    + CPSR_c表示CPSR中的最后8位即【0 - 7】这样写可以更改模式
  + cxsf表示全部部分

  <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622221200775.png" alt="image-20240622221200775" style="zoom:50%;" />

+ 软中断指令:
  + <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622221339052.png" alt="image-20240622221339052" style="zoom:50%;" />
  + **用途**:主要用于程序调用操作系统的API
  + 两种参数传递方法:
    + 1、指令中的24bit立即数指定API号，其它参数通过寄存器传递
    + <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622221952603.png" alt="image-20240622221952603" style="zoom:50%;" />
    + 2、忽略指令中24bit立即数，由R0指定API号，其它参数通过其它寄存器传递
    + <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622222129766.png" alt="image-20240622222129766" style="zoom:50%;" />

+ 伪指令:

  + "伪"表示不属于ARM指令集中的指令，**为了编程方便而定义得到的**

  + 可以像其它ARM指令一起使用但在编译时被一条或者多条ARM指令所代替

  + 常用ARM伪指令:

    + ADR/ADRL 【小/中范围的地址读取】

      <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622222417540.png" alt="image-20240622222417540" style="zoom:50%;" />

      <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622222556805.png" alt="image-20240622222556805" style="zoom:50%;" />

![image-20240622222701791](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622222701791.png)

+ + + LDR 【加载32位立即数，或一个地址值到指定寄存器】

      <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622222805185.png" alt="image-20240622222805185" style="zoom:50%;" />

    + EQU 【将一个数值或寄存器名赋给一个指定的符号名】

    <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622222917195.png" alt="image-20240622222917195" style="zoom:50%;" />

    <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622222933083.png" alt="image-20240622222933083" style="zoom:50%;" />

    + NOP 【空操作】

      <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240622223002888.png" alt="image-20240622223002888" style="zoom:50%;" />

Thumb指令:

+ Thumb指令可以看作是ARM指令压缩形式的子集
  + 减小代码量
  + 具有16位代码密度
  + 体系不完整，只支持通用功能
  + 必要时仍需要ARM指令【进入异常时】

### 第四章 嵌入式存储器系统

#### 4.1嵌入式存储器类型

**按照用途分类**:

+ 主存储器
  + 用来存放正在执行的或经常使用的程序代码和数据
    + 通常由半导体存储器构成，位于**微处理器芯片内部**或者主板上
    + **存取速度快**，cpu可以直接对主存进行访问
    + **容量有限**，其大小受地址总线位数的限制
+ 外部存储器
  + 用来存放暂时不使用的程序代码和数据
    + **位于主板之外**
    + **存取速度慢**，微处理器不能直接访问，仅在需要时被调入主存
    + **容量大，成本低**，所存储的信息可以长期保存，且能修改

**按照存储介质分类**:

+ 半导体存储器
  + 采用**大规模集成电路技术**将大量的**存储单元**制作在一个芯片中
  + **使用最广泛**，主要用作**主存储器和高速缓冲存储器Cache**也可能用作外部存储器
+ 光盘存储器
  + 利用介质的光效应，以**被照射部分的平面和凹坑光反射率不同表示信息"0"或"1"**
+ 磁表面存储器
  + 利用磁化状态来记录"0"和"1"

**按存取方式分类**

+ 随机存取存储器RAM：可以随机选中任一存储单元，可读可写，对每个地址单元的读写时间相同，主要用于**主存与高速缓存**

  + 静态随机存取存储器SRAM:
    + 双稳态触发器
    + 存储内容可**长时间保持**，除非**掉电或执行写操作**
    + 速度快，集成度低，结构复杂，功耗大
  + 动态随机存取存储器DRAM:
    + 电容
    + 需要周期性刷新
    + 速度比SRAM慢，集成度高成本低功耗低
  + 同步动态随机存取存储器SDRAM
    + 将CPU和RAM共享一个时钟周期，两者以相同的速度同步工作，**每一个时钟脉冲上升沿开始传输数据**
  + 双倍数据速率动态随机存取存储器DDR SDRAM
    + 允许在时钟脉冲的上升沿和下降沿两次传输数据

+ 顺序存取存储器SAM:以文件或数据的形式按顺序存放，对不同地址的存储单元读写所需时间也不同，容量大、价格低，**但存取速度慢，只适合用作外存**

+ 直接存取存储器DAM:当存取信息时，先指向一个区域，然后在这一区域进行顺序检索，存取信息所用的时间与信息所在的地址有关【磁盘存储器】

+ 只读存储器ROM:使用前写入信息并存储，运行时只能从中读出信息，不能写入，**电源关闭后，存储的信息不会丢失，**常用来存放系统固化的程序

  <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240623203156626.png" alt="image-20240623203156626" style="zoom:50%;" />

+ 闪速存储器Flash Memory: 即可在不加电的情况下长期保存信息，又能在线进行快速擦除与重写，具有ROM和RAM的优点

  + **非易失性存储器，可读可写**

+ **Nor Flash存储器**:

  + 具有芯片内执行特性，应用程序可以直接在其内运行，不必先读到RAM中再运行
  + 数据传输效率很高，使用方便
  + 写入与擦除速度快

+ **NAND Flash存储器**:

  + 能提供极高的单元密度，可以达到高存储密度，写入与擦除速度也很快
  + 存储管理较为复杂、系统接口特殊

**对比**:

+ 1、**NAND Flash 写入速度比Nor Flash快很多**，而**Nor Flash读取速度比NAND Flash快一点**
+ 2、**NAND Flash**最大擦写次数是100万次 **Nor Flash**是10万次
+ 3、**Nor Flash主要用于程序存储，而NAND Flash同时适用于数据存储** 

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240623222625189.png" alt="image-20240623222625189" style="zoom:50%;" />

---

#### 4.2 存储器系统结构

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240623205036544.png" alt="image-20240623205036544" style="zoom:50%;" />

**存储器系统空间分布**:

+ 支持小端/大端模式 【通过编程设定】
+ 可寻址**外部存储空间为1GB**
  + 被分成8个Bank 每个Bank为128MB (128MB* 8 = 1GB)
  + **Bank0**的**数据位宽只能是16或32位【由引脚电平决定】，其它Bank可以编程设定为8、16、32位**
  + 前6个Bank(**Bank0 - Bank5**)可以外接**ROM、SRAM类型的存储器** **Bank6和Bank7**可以外接**ROM、SRAM、SDRAM**
  + Bank6和Bank7的大小可以编程设定
  + 前7个Bank(Bank0-6)有固定的起始地址；最后1个Bank起始地址 = Bank6末地址 + 1
  + 所有Bank的访问周期可以编程设定
+ <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240623212830814.png" alt="image-20240623212830814" style="zoom: 50%;" />

**上图还指出了OM引脚的取值决定了Bank0 与是否采用NANDFlash模式，数据总线的宽度与这个存储块的容量大小没有直接关系**  

Bank1 - Bank7 【Bank6 Bank7特殊】

+ 数据总线宽度应设置为8位，16位，32位
+ 外接**SRAM**类型存储器或具有SDRAM接口特性的**ROM存储器** 【Bank6 Bank7 还可以外接**SDRAM**】
+ Bank6和Bank7的容量可以编程设定，**且二者必须相等**

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240623220117359.png" alt="image-20240623220117359" style="zoom:50%;" />

**可以看到使用NAND Flash下的会使用BooT**【**4KB**】

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240623223623032.png" alt="image-20240623223623032" style="zoom:200%;" />

NAND Flash作为引导程序时候放在Bank0

---



#### 4.3 外部存储器芯片连接

常见外部存储器芯片

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240623224034533.png" alt="image-20240623224034533" style="zoom:33%;" />

微处理器芯片与外部存储器芯片的连接本质就是三种总线的连接【数据总线 地址总线 控制总线】

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240623224230516.png" alt="image-20240623224230516" style="zoom:50%;" />

**数据总线的连接**

+ 将存储器芯片的数据引脚与微处理器芯片的数据引脚顺序连接

**控制总线的连接**

+ 将存储器芯片的控制引脚与微处理器芯片对应的控制引脚连接

**地址总线的连接**

+ 与系统数据总线的宽度有关

![image-20240624090755522](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624090755522.png)

**数据总线的位置不同时，存储器芯片的地址引脚进行连接的位置也不同 **

**注意 由于存储器芯片均是8位 构成s3c2440的时候需要进行位扩展**

+ 8位存储器芯片构成8位存储系统:

  <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624091015190.png" alt="image-20240624091015190" style="zoom:50%;" />

**存储器地址线A0,A1,...分别与s3c2440的地址总线ADDR0，ADDR1...相连接**

+ 8位存储器芯片构成16位存储系统:

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624091851254.png" alt="image-20240624091851254" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624091927144.png" alt="image-20240624091927144" style="zoom:50%;" />

**存储器地址线A0,A1,...分别与s3c2440的地址总线ADDR1,ADDR2...进行连接**

+ 8位存储器芯片构成32位存储系统:\

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624092827654.png" alt="image-20240624092827654" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624092903363.png" alt="image-20240624092903363" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624092913431.png" alt="image-20240624092913431" style="zoom:50%;" />

**8位存储器芯片的地址线A0,A1,...分别与s3c2440地址总线的ADDR2,ADDR3...相连**

+ 16位存储器芯片构成16位存储系统

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624093237850.png" alt="image-20240624093237850" style="zoom:50%;" />

**如图 存储器地址线与s3c2440连接时 地址线的连接只与想要构成的位数相关 **

图中想要构成16位存储系统，因此连接时需要:**A0,A1,...与s3c2440的ADDR1,ADDR2...**相连接

+ 16位存储器芯片构成16位存储系统（SRAM与SDRAM形式）

![image-20240624093720952](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624093720952.png)

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624094200901.png" alt="image-20240624094200901" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624094306490.png" alt="image-20240624094306490" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624094353535.png" alt="image-20240624094353535" style="zoom:50%;" />

---

#### 4.4 Nor Flash存储器芯片

+ 读取速度快，具有**芯片内执行XIP特性**
+ 写入速度慢，单位体积下容量小，价格高
+ 擦写次数约10万次
+ 带有SRAM接口，与微处理器连接方便，便于数据存取
+ **适用于存储固化的系统启动引导代码、操作系统代码、应用程序代码**

+ **通常配置在Bank0**,系统上电或复位后从其内获取指令并开始执行

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624100122509.png" alt="image-20240624100122509"  />

+ **单片存储容量为2MB，有20根地址线**【20根 - >1MB **但是由于芯片以16位数据线宽度进行工作(每次寻址2B 因此 20地址线而不是21根)**】
+ 工作电压2.7 - 3.6V
+ 采用48脚TSOP封装或48脚TFBG封装

+ 微处理器芯片的OM1引脚接地，OM0引脚接高电平

  <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624101547773.png" alt="image-20240624101547773" style="zoom:67%;" />

![image-20240624101851821](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624101851821.png)

【上述芯片的16、32、64 并不表示数据线的位数而表示的是存储容量】

---

#### 4.5 NAND FLash 存储器芯片

+ 擦除和写入速度很快，单位体积下数据存储密度大，价格相对便宜
+ 使用时需要复杂的**I/O接口电路【专用控制器】**和存储管理操作
  + 以**页**为最小单位进行读写操作，以**块**为最小单位进行擦除
+ 擦写次数100万次
+ 适用于存储大量用户数据和程序代码
+ **支持自动启动引导**

**8位NAND Flash控制器引脚:**

+ I/O引脚:用于输出地址、命令、输入/输出数据 【分时复用】
+ 控制引脚:
  + 1、CLE :命令锁存使能
  + 2、ALE:地址锁存使能
  + 3、nFCE:片选
  + 4、nFRE:读使能
  + 5、nFWE：写使能
+ 状态引脚:
  + 1、FR/nB:准备就绪或忙状态信号  【0:忙，程序不能对芯片进行操作；1就绪，可以操作芯片】

![image-20240624105133520](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624105133520.png)

+ **有效容量**:被分为**4096**块 每块**32**页 每页**528**字节 【前512字节用于存放有效数据，后16字节用于存放ECC代码文件，坏块信息和文件系统代码等辅助数据】
+  没有对外的地址线但芯片内部使用地址线<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624105936558.png" alt="image-20240624105936558" style="zoom: 50%;" />表示各字节单元地址

![image-20240624110356545](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624110356545.png)

+ **采用四步寻址法**:

![image-20240624111003916](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624111003916.png)

**与NAND Flash相关的微处理器引脚**:

+ 1、存储器选择位 NCON
+ 2、存储器页容量选择位GPG13
+ 3、存储器地址周期选择位GPG14
+ 4、存储器总线宽度选择位CPG15

**NAND Flash存储器两种工作模式**:

1、自动引导模式:

S3C2440的引脚OM1:OM0均接低电平时，系统处于NAND Flash自动引导模式

2、普通闪存模式:

支持数据读、写、擦除操作

---

#### 4.6 存储器控制寄存器

1、**总线宽度和等待控制寄存器BWSCON**

![image-20240624120844208](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624120844208.png)

2、**存储块控制寄存器BANKCONn[n= 0 - 7 ]**

3、**刷新控制寄存器REFRESH**

4、**存储块大小控制寄存器BANKSIZE**

![image-20240624121219760](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624121219760.png)

#### 与NAND Flash存储器相关的寄存器

1、**配置寄存器NFCONF**

2、**控制寄存器NFCONT**

3、**命令寄存器NFCMMD**

4、**地址寄存器NFADDR**

5、**数据寄存器NFDATA**

6、**状态寄存器NFSTAT**

### 第五章 常用外围设备与接口

#### 5.1 通用输入输出端口 【GPIO】

+ 通用GPIO端口用于连接各类输入、输出设备，实现其与微处理器之间的数据传输

---

**端口A**

+ 23个引脚
+ 两种功能:
  + 普通**输出**口
  + 用于**输出外接存储器**的地址信号和存储块选择信号，以及外接**NAND Flash的存储器控制信号**

---

**端口B**

+ 11个引脚
+ 两种功能:
  + 普通**输入/输出口**
  + 用于**DMA和【总线请求信号和应答信号】**以及各种**时钟信号**

---

**端口C**

+ 16个引脚
+ 两种功能
  + 普通**输入/输出口**
  + 用于**LCD显示器**的数据信号和控制信号

---

**端口D**

+ 16个引脚
+ 三种功能
  + 普通**输入/输出口**
  + 用于**LCD显示器的**数据信号
  + 用于**SPI总线**的控制信号

---

**端口E**

+ 16个引脚
+ 三种功能
  + 普通**输入/输出口**
  + 用于**SPI、<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624152201463.png" alt="image-20240624152201463" style="zoom: 80%;" />C、<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624152225556.png" alt="image-20240624152225556" style="zoom:80%;" />S总线**和**SD存储器**的控制信号
  + 用于**AC'97音频接口**的控制信号

---

**端口F**

+ 8个引脚
+ 两种功能
  + 普通**输入/输出口**
  + 用于**中断请求信号【常用】**

---

**端口G**

+ 16个引脚
+ 三种功能:
  + 普通**输入/输出口**
  + 用于**中断请求信号**
  + 用于**SPI总线、LCD显示器的**控制信号

---

**端口H**

+ 11个引脚
+ 三种功能
  + 普通**输入/输出口**
  + 用于**异步串行接口UART**的控制信号(仅两个)

---

**端口J**

+ 13个引脚
+ 两种功能
  + 普通**输入/输出口**
  + 用于**摄像头接口**的数据信号和控制信号

---

**I/O端口的使用**

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624154138565.png" alt="image-20240624154138565" style="zoom:80%;" />

**端口A的控制寄存器【2】**

GPACON :配置端口A的引脚【只能配置两种功能（输出以及其它）】

GPADAT :端口A的数据寄存器<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624154634800.png" alt="image-20240624154634800" style="zoom:67%;" />

---

**端口B的控制寄存器【3】**

GPBCON :配置端口B的引脚【有三种(有一种对应保留位)输入，输出及其它 】

GPBDAT:端口B的数据寄存器<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624155703725.png" alt="image-20240624155703725" style="zoom:50%;" />

GPBUP:端口B的上拉使能寄存器<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624155725788.png" alt="image-20240624155725788" style="zoom:50%;" />

**用途：简化嵌入式系统的硬件电路设计，对于需要上拉电路的IO端口，无需设计上拉电阻**

**驱动强度控制器**【**2**】: 

+ 用于设置ARM微处理器芯片**数据总线、地址总线以及部分作为第二、第三功能使用的GPIO引脚的驱动电流大小**

**有关LED的点亮配置:**

首先配置CON【将地址送入寄存器 取出寄存器中内容 放回寄存器】

接着配置DAT【将地址送入寄存器 取出寄存器中内容 配置结束后放回】

---

#### 5.2 中断系统

**中断的概念:**微处理器在执行正常程序的过程中，因某事件发生，收到来自外围设备的请求信号

**中断的作用:**1、并行处理 2、实时处理 3、故障处理

**中断系统的构成**:**由芯片外部中断请求引脚和内部外设触发的是外部中断请求(IRQ)和快速中断请求(FIQ)**

+ 借助**中断控制器**，接收并管理60个中断源发出的中断请求信号
+ <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624200353831.png" alt="image-20240624200353831" style="zoom:67%;" />

![image-20240624201053913](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624201053913.png)

+ **一级中断源共有32个** 
+ **二级中断源共有15个 对应着一级中断源** 
+ 观察上图可以算出 :一级中断源为32 外部中断源为20(20个映射入一级中断因此 32+20-2 = 50)
+ 50+15二级中断源 = 65 又因为二级中断源对应1级别中断源的六种 六种应该减去
+ 故:65 - 6 = 59 种 还有一种上课讲的是LCD但记不清了

---

**中断控制器功能:**

1、外部中断请求信号管理

2、中断模式设定

3、中断请求标记

4、中断屏蔽设定

5、中断优先级管理

6、中断服务标记

---

**中断管理功能的实现**【特殊功能寄存器SFR——17个】

![image-20240624203319054](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624203319054.png)

**1、源挂起寄存器**【SRCPND】

+ 用于**标记**32个一级中断源的中断请求信号是否触发，即是否有中断等待处理，供中断服务程序读取和判断
+ 每一位都由**中断源自动置位**，**无论该中断源是否被设定为屏蔽，也不受优先级逻辑的影响**
+ 为了保证能收到同一中断源的下一次中断请求，通常需要在中断服务程序中**人工清除置位**【**通过写入数据来进行清除。写入"1"表示清除，"0"表示不变**】
+ **注意**:![image-20240624205116565](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624205116565.png)

**上述20个与外部中断挂起寄存器(EINTPEND)一同确定EINT4 - EINT23中具体哪些信号有效**

**2、中断模式寄存器**【INTMOD】

+ 用于设定**32**个**一级中断源**的中断模式
  + 若设置为"**1**"，则相应的中断源按照"**FIQ**"模式处理
  + 若设置为"**0**",则相应中断源按照"**IRQ**"模式处理
+ **注意:同一时刻，仅有一个中断源能够在"FIQ"模式下处理，仅有一个位置可以被置1，因此，应该将最紧迫的中断源设置为FIQ模式**【独热】

**3、中断屏蔽寄存器**【仅仅对**IRQ**模式有效】【INTMSK】

+ 用于**设定**32个一级中断源是否被允许中断
  + 若设置为"1"，则相应中断源不会被服务
  + 若设置为"0",则相应中断源可以被服务
+ **注意**：![image-20240624211059777](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624211059777.png)

**上述20个与外部中断屏蔽寄存器EINTMASK一同确定EINT4 - EINT23中具体哪些信号被屏蔽/允许**

**4、中断优先级寄存器**【PRIORITY】

+ 当多个中断源的中断请求信号同时有效时，需要通过**中断优先级**来确定对这些中断请求的服务顺序
+ **中断控制器**借助**优先级裁决器(仲裁判决器)**实现对32个一级中断源的优先级判决

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624212401402.png" alt="image-20240624212401402" style="zoom:67%;" />

通过上图可知:首先通过一级裁决器决定出最优的 之后送入二级裁决器第二次判断找出最优 最后由二级裁决器输出的结果送入内核进行响应

中断优先级顺序:【如上图所示，REQ0 与 REQ5的优先级无法进行更改】

**1、静态优先级**【优先级固定】

+ REQ1 - REQ4的优先级一旦通过程序设定好就无法更改

**2、动态优先级**【优先级循环】

+ REQ1 - REQ4的优先级通过程序设定好之后，只要被中断处理后，则其优先级自动降为最低

**优先级寄存器**:

+ 用于设定32个一级中断源在**IRQ模式下**的优先级顺序
+ 每个裁决器的优先级分别通过2位ARB_SEL(优先级顺序)和1位ARB_MODE(优先级类型)来设定

**5、中断挂起寄存器**【INTPND】

+ 用于标记32个一级中断源的中断请求是否即将或正在被微处理器服务
  + "1"表示所对应的中断在所有已触发的中断中优先级最高且没有被屏蔽
+ 位于优先级逻辑后，故**同一时刻**，只有1位被置1，并向微处理器发出IRQ信号 【仅对IRQ模式的中断有效】
+ 通常需要在中断服务程序中人工**清除置位**【写入"1"表示清除 "0"表示保持不变】

**6、中断偏移寄存器**【INTOFFSET】

+ 用于标记INTPND中置"1"位对应中断源的偏移量，其值代表了即将或者正在被微处理器服务的中断源号
+ 一旦**人工清除了**SRCPND和INTPND中的置"1"位，则该寄存器的值会自动清除
+ **注意**:与INTPND一样 仅对IRQ模式的中断有效

---

二级中断源相关【2】:

**1、次级源挂起寄存器**:【SUBSRCPND】

**2、中断次级屏蔽寄存器**【INTSUBMSK】

与外部中断源相关【9】:

**1、外部中断控制寄存器 【EXTINT0 - EXINT2】**

+ 用于设定外部**中断请求信号的触发方式**
  + 电平触发:低电平触发、高电平触发
  + 边沿触发:下降沿触发、上升沿触发、双边沿触发

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625095115587.png" alt="image-20240625095115587" style="zoom: 50%;" />

+ **注意**EXTINT0无法设置滤波使能，外部中断0-7 无滤波使能，在EXTINT0中滤波位被设置为保留位不使用

**2、外部中断滤波寄存器【EINTFLT0 - EINTFLT3】**

+ 用于设定**8个**外部中断请求信号【EINT**16** - EINT**23**】的滤波器的时钟信号来源和滤波宽度
+ 为了确保微处理能有效检测到外部中断请求信号，要求信号的有效逻辑电平至少保持40ns
+ **EINTFLT0 与 EINTFLT1 两个寄存器作为保留 不设定滤波器的时钟信号来源和滤波宽度**
+ EINTFLT2 与EINTFLT3 被称为外部中断滤波寄存器2 和外部中断滤波寄存器3

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625101414288.png" alt="image-20240625101414288" style="zoom: 50%;" />

**注意**:只能设置8个中断【EINT16 - EINT23】

**3、外部中断屏蔽寄存器【EINTMASK】**

+ 用于设定**20个**外部中断请求信号【**EINT4 - EINT23**】是否允许中断 (外部中断**EINT0 - EINT3**)是由中断屏蔽寄存器INTMSK设定的
+ <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625102218833.png" alt="image-20240625102218833" style="zoom:50%;" />

**4、外部中断挂起寄存器【EINTPEND】**

+ 用于标记**20**个外部中断请求信号【EINT4 - EINT23】是否触发，供中断服务程序读取和判断(EINT0 - EINT3 是由中断挂起寄存器设定的)
+ <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625102550501.png" alt="image-20240625102550501" style="zoom:50%;" />

**注意:**与源挂起寄存器，中断挂起寄存器，次级中断挂起寄存器与外部中断挂起寄存器一样 都是通过写入"1"进行清0

![image-20240625113325183](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625113325183.png)

由上图简述中断处理流程：

首先设备检测到中断，分为三种中断源

1、将一级中断直接送入源挂起寄存器【SRCPND】

2、如果是外部中断源【EINT4 -EINT23】，则由硬件自动将**外部中断挂起寄存器**[EINTPEND]对应位置置1，之后通过**外部中断屏蔽寄存器**[EINTMASK]对其中的部分进行屏蔽，最后将未被屏蔽的外部中断送入源挂起寄存器

3、如果是二级中断源，则由硬件将次级源挂起寄存器[SUBSRCPND]中对应的位置1，之后通过中断次级屏蔽寄存器[SUBMSK]对其中部分进行屏蔽，最后将未被屏蔽的二级中断源送入源挂起寄存器。

**注意:此时对于外部中断【EINT4-23】需要两层 由外部中断挂起寄存器标记是哪一个 然后送入源挂起寄存器中的对应位 其中只有两位一位表示 EINT4 - EINT7 另一位表示EINT8 - EINT23**

设置对应源挂起寄存器之后【SRCPND】通过中断模式寄存器【INTMOD】设置是否有FIQ中断，INTMOD一次最多只有一位为1，对应FIQ中断 剩余都为普通中断IRQ

**注意:设置完后需要设置CPSR中的相应位置需要允许FIQ和IRQ中断** 有FIQ中断时直接进行执行快速中断

![image-20240625120207389](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625120207389.png)

之后将对应**IRQ**模式下中断送入中断屏蔽寄存器【INTMSK】中进行屏蔽【**仅仅对IRQ模式下的中断有效**】，之后送入优先级寄存器【PRIORITY】中选出优先级最高的中断，此时仅仅有一个优先级最高的中断，将这个中断在中断挂起寄存器【INTPND】和中断偏移寄存器【INTOFFSET】中相应置位，最后由内核进行响应

**注意:中断源挂起寄存器是独热的一次只能有一个为1 清零时候需要写入1进行清除 **

在中断过程中需要写入1清除的寄存器有：次级源挂起寄存器、外部中断挂起寄存器 源挂起寄存器、中断挂起寄存器【中断偏移寄存器随着中断挂起寄存器的设置自动清除】

---

#### 5.3 定时部件

+ 时钟部件
  + 为微处理器工作提供基本的时钟信号，以实现其内部功能电路及外围设备的时序控制
+ 定时部件
  + 产生不同周期或特定波形的时钟信号，满足不同的实际应用需求
  + 对外部输入信号进行计数
  + 为系统提供时间信息，例如年、月、日、等
  + **当系统出现故障时，为各控制器提供复位信号**

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625144238113.png" alt="image-20240625144238113" style="zoom:50%;" />

时钟控制模块

+ 三种内部时钟信号

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625144644886.png" alt="image-20240625144644886" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625144656006.png" alt="image-20240625144656006" style="zoom: 67%;" />

+ 两种时钟源:1、晶体振荡器 2、外部时钟源
+ **时钟频率计算**

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625145530964.png" alt="image-20240625145530964" style="zoom: 67%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625145702465.png" alt="image-20240625145702465" style="zoom:67%;" />

+ 锁相环配置寄存器**MPLLCON**是用于配置分频控制参数的

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625145851989.png" alt="image-20240625145851989" style="zoom:67%;" />

+ 时钟分频控制寄存器**CLKDIVN**用于设定三种时钟信号的比例关系即【FCLK HCLK PCLK三者的关系】

---

**定时器**

+ 功能: 定时、计数、脉宽调制(PWM)

+ 5个16位定时器(递减计数器)
  + 定时器**0、1、2、3**具有**PWM功能**
  + **定时器4是一个无输出引脚的内部定时器**
  + 定时器**0**还包含**用于大电流驱动的死区发生器**
  + 每个定时器都包含一个可以生成5种不同分频信号【1/2，1/4，1/8，1/16 和**外部时钟TCLK**】的时钟分频器
  + 定时器配置寄存器【TCFGn TCFG0用于配置预分频值(**预分频器**) TCFG1用于配置分频值(**时钟分割器**)】

**定时器的工作原理**:

+ 实际执行**减1操作**的是**定时计数寄存器TCNTn**。为了方式对其读写影响计数，**不允许程序对其直接访问**

  + 将**计数初值**写入定时计数缓冲寄存器TCNTBn,每次定时开始时，其值会被复制到TCNTn中，同时TCMPBn【定时比较缓冲寄存器】 - > TCMPn【定时比较寄存器】
  + 读取TCNTBn时，读出的是下次定时操作的重载值，并非TCNTn的当前计数值
  + 读取**定时器计数监视寄存器TCNTOn,可以间接获取TCNTn的动态计数值**

+ 启动计数后，TOUTn引脚的输出信号进行第一次反相<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625153617606.png" alt="image-20240625153617606" style="zoom:33%;" />

+ 当**【定时计数寄存器】TCNTn**等于**定时比较寄存器【TCMPn】**时，TOUTn引脚的输出信号进行**第二次反相**<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625154332369.png" alt="image-20240625154332369" style="zoom:33%;" />

+ TCNTn减小到0时，若没有屏蔽允许，则会触发TIMERn中断。并根据**定时器控制寄存器TCON**的自动重载标志，决定是否复制TCNTBn 至 TCNT中以开启下一次定时操作

  ![image-20240625153629735](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625153629735.png)

**该图对应着上述的流程**

TCNTBn 与TCMPBn有**双缓冲功能**，当前定时操作中设置有新的定时器值，仅当当前定时操作执行完毕后才有效【**非立即有效**】

![image-20240625160015261](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625160015261.png)

上图是在计数还未结束的时候发生的当前周期结束后会重新写入新的寄存器中

**注意:下图写的是定时中断中写入的计数 也就是当前计数已经结束了 但是仍处于当前计数周期的中断中 也就是从脉冲上升沿开始时才算计数开始 但是一定要注意的是在计数器清零后设置了自动重载 此时之前的内容已经被加载进入TCMPn中了 而在中断中写入的需要等这次运行周期结束后才能被加载**

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625160201490.png" alt="image-20240625160201490" style="zoom: 67%;" />

相关寄存器介绍:

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625165506319.png" alt="image-20240625165506319" style="zoom:67%;" />

+ **定时器配置寄存器【TCFG0、TCFG1】:**

  + TCFG0:【配置两个8位预分频器】<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625165206526.png" alt="image-20240625165206526" style="zoom:50%;" />

  + TCFG1:【配置时钟分割器(5路多路选择器)及DMA模式选择寄存器】

+ **定时器控制寄存器【TCON】**

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625165556506.png" alt="image-20240625165556506" style="zoom:67%;" />

![image-20240625170410785](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625170410785.png)

**注意:PWM定时输出信号频率也就是每隔多长时间的频率 比如实验中每隔两秒进行说明PWM的信号输出频率为0.5hz 即两秒输出一个波形**

PWM不反相时表示开始是高电平当计数开始时反相 

反相表示开始时为低电平 计数开始后为高



+ 定时器0相关寄存器:
  + TCNTB0：定时器0计数缓冲寄存器【计数初值 倒数】
  + TCMPB0：定时器0比较缓冲寄存器 【比较值】
  + TCNTO0：定时器0计数监视寄存器 【读取TCNT0的当前值】

+ 定时器1相关寄存器:

  + TCNTB1：定时器1计数缓冲寄存器
  + TCMPB1：定时器1比较缓冲寄存器
  + TCNTO1：定时器1计数监视寄存器

+ 定时器2相关寄存器:

  + TCNT2：定时器2计数缓冲寄存器
  + TCMP2：定时器2比较缓冲寄存器
  + TCNTO2：定时器2金属监视寄存器

+ 定时器3相关寄存器：

  + TCNT3：定时器2计数缓冲寄存器

  + TCMP3：定时器2比较缓冲寄存器
  + TCNTO3：定时器2金属监视寄存器

+ **定时器4相关寄存器【无比较缓冲寄存器，因为定时器4没有PWM输出端】**：
  + TCNT4：定时器4计数缓冲寄存器
  + TCNTO4：定时器4计数监视寄存器

**自动重载:将TCNTBn和TCMPBn送入对应的TCNTn与TCMPn中**

**手动更新:更新TCNTBn和TCMPBn的值**  以及实现第一次计数值的加载 

占空比:是指高电平占整个周期时间

**实时时钟**：

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625174957755.png" alt="image-20240625174957755" style="zoom:50%;" />

**看门狗定时器**:

+ WDT 是一种用于当噪声或系统错误引起故障时，恢复微处理器操作的定时器
+ **本质上是一个16位内部定时器**，当计数值为0(即超时)时，通过触发中断服务，激活**128**个PCLK时钟周期内部的复位信号
+ 可用作一个普通的带中断请求(INT_WDT)的16位定时器
+ **只能**使用**PCLK时钟信号**作为源输入时钟信号，且没有对外的**输出信号引脚**
+ 系统处于**嵌入式ICE调试模式时**WDT必须无操作

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625175816872.png" alt="image-20240625175816872" style="zoom:67%;" />

**看门狗相关寄存器**:

1、WTCON【看门狗定时器控制寄存器】

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625180011224.png" alt="image-20240625180011224" style="zoom:50%;" />

2、WTDAT【看门狗定时器数据寄存器】

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625180444450.png" alt="image-20240625180444450" style="zoom:67%;" />

所需的时间间隔指的是指在设置看门狗定时器时，您期望定时器在触发事件（如中断或系统重置）之前应持续的时间长度

3、WTCNT【看门狗定时器计数寄存器】

**注意事项**：

+ 看门狗定时器的中断与复位:
  + **看门狗定时器中断**是看门狗定时器作为普通定时器应用时向微处理器发出内部中断请求
  + **看门狗定时器复位**是让微处理器复位，相当于重启所有程序
+ 看门狗定时器数据寄存器【WTDAT】存放WDT的计数初值，相当于TCNTBn
+ WTCNT 是WDT的减1计数器，相当于普通定时器的TCNTn【程序不能直接访问】
+ **注意**:不同于普通定时器，**WTDAT的值在WDT初始使能时，不能自动装载到WTCNT中，因此**“
+ 第一次使能”是指在系统启动或复位后，第一次启用看门狗定时器。由于 `WTDAT` 的值不会在首次使能时自动加载到 `WTCNT`，所以必须手动设置 `WTCNT`。在随后的操作中，看门狗定时器会自动从 `WTDAT` 中重载计数值。

![image-20240625182743005](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625182743005.png)

当为系统复位时表示需要重新设置WTCNT 定期喂狗时是从WTDAT中自动装载进入WTCNT中

---

### 第六章 嵌入式Linux相关与系统编程

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624170004748.png" alt="image-20240624170004748" style="zoom:80%;" />

**嵌入式系统的启动流程:**

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624170220765.png" alt="image-20240624170220765" style="zoom:150%;" />

使用**NOR Flash 为引导启动流程时，【存放BootLoader】CPU执行从NOR Flash中读取引导程序无需预先加载到RAM中 **，之后从NAND Flash加载操作系统到外部RAM中通过执行部件进行执行

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624170618018.png" alt="image-20240624170618018" style="zoom: 150%;" />

而使用**NAND Flash为引导ROM的启动流程时,NAND Flash 中存放BootLoader，由于CPU从NAND Flash中读取BootLoader时需要专门的算法 因此需要将 BootLoader加载进入内部RAM中进行执行操作 【在其中主要执行的式SteppingStone部分】 **，之后NAND Flash加载至外部RAM中通过执行部件进行执行操作

#### 6.1 Bootloader程序:

**Bootloader【引导装载程序】**是嵌入式系统上电之后、**操作系统内核**运行之前运行的第一段程序

+ 用途:对系统的硬件设备进行初始化，将操作系统映像装载到内存中，并建立内存空间的映射图，从而**为最终调用操作系统内核准备好正确的软硬件环境**

 **Bootloader运行模式** :

![image-20240624173435318](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624173435318.png)

1、启动加载模式:【自主模式，是**Bootloader 正常的工作模式**】

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624173948117.png" alt="image-20240624173948117" style="zoom:50%;" />

2、下载模式 :【用于系统调试或版本修改/升级】

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624174110276.png" alt="image-20240624174110276" style="zoom:67%;" />

**Bootloader 通常分为stage1 和stage2两部分**:

stage1通常用汇编语言实现，stage2通常用C语言实现<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624174250963.png" alt="image-20240624174250963" style="zoom:67%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624174419721.png" alt="image-20240624174419721" style="zoom:50%;" />



<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624175201543.png" alt="image-20240624175201543" style="zoom:50%;" />



#### 6.2 嵌入式操作系统

![image-20240624180303569](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240624180303569.png)

**五个主要子系统**:进程调度、进程间通信、内存管理、虚拟文件系统、网络接口

**内核烧写**:通过串口、通过MicroUSB口、通过SD存储卡、通过网络、通过JTAG接口

![image-20240625194836477](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625194836477.png)



![image-20240625195440999](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625195440999.png)

![image-20240625195521967](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625195521967.png)

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625195655669.png" alt="image-20240625195655669" style="zoom:67%;" />

Linux中三种基本文件类型:**普通文件、目录文件、设备文件**

所有设备的文件存放在**/dev目录**下

Shell种类:

+ ash、bash【GNU默认的shell】、tcsh

Shell主要功能:

+ 命令解释器、命令通配符、命令补全、别名机制、命令历史

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625200449993.png" alt="image-20240625200449993" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625200516349.png" alt="image-20240625200516349" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625200559735.png" alt="image-20240625200559735" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625200822125.png" alt="image-20240625200822125" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625201140049.png" alt="image-20240625201140049" style="zoom:50%;" />



su - root 与su root 的区别：前者为完全切换用户 后者为切换基本用户【不改变环境变量】

**访问权限相关**:

![image-20240625202217202](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625202217202.png)

对文件或目录进行访问的三种用户类型:

**文件所有者，与所有者同组的用户，其它用户**

![image-20240625202724913](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625202724913.png)

![image-20240625202905300](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625202905300.png)

#### 6.4 Shell编程

+ Shell程序的特定及用途:
  + 可以认为是将Shell命令按控制结构组织到一个文本文件中批量地交给Shell去执行
  + **解释执行**，不生成可以执行地二进制文件

**Shell程序的一般结构**:**Shell类型、函数、主过程**

Shell程序的编译过程:**编辑文件、保存文件、将文件赋予可以执行的权限、运行及排错**

Shell**中使用变量无需事先声明**

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625204149503.png" alt="image-20240625204149503" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625204446892.png" alt="image-20240625204446892" style="zoom:50%;" />

嵌入式系统采用**双机开发模式**

![image-20240625210654060](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625210654060.png)

交叉编译:

+ 在一种平台上编译运行于另一种平台上的程序
+ 用来编译这种程序的编译器称为交叉编译器

软件开发流程:

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625210901910.png" alt="image-20240625210901910" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625211110012.png" alt="image-20240625211110012" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625211811070.png" alt="image-20240625211811070" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625212357738.png" alt="image-20240625212357738" style="zoom: 50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625212414870.png" alt="image-20240625212414870" style="zoom:50%;" />

**gcc的使用与开发**:

1、使用gcc编译代码 - >[.c]文件

2、生成预处理文件 .c - >.i<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625214603135.png" alt="image-20240625214603135" style="zoom:50%;" />

3、生成汇编文件 .i - > .s <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625214954595.png" alt="image-20240625214954595" style="zoom:50%;" />

4、生成目标文件 .s - >.o <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625215041441.png" alt="image-20240625215041441" style="zoom:50%;" />

5、生成可执行文件 .o - > 可执行文件 <img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625215143126.png" alt="image-20240625215143126" style="zoom:50%;" />

<img src="C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625215448640.png" alt="image-20240625215448640" style="zoom:50%;" />

![image-20240625221458797](C:\Users\12074\AppData\Roaming\Typora\typora-user-images\image-20240625221458797.png)
